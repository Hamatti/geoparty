<!doctype html>
<html>
<head>

    <title> GeoParty - The Game with Answers </title>

    <meta charset="utf8" />
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>

        .gamearea {
            height: 800px;
            margin-right: 30px;
        }

        .overlay {
            height: 800px;
            margin-right: 30px;
            background: url('/img/bg.gif');
            color: white;
            font-size: 40px;
            text-align: center;
        }

        .overlay p {
            margin-top: 30%;
        }
        
        .overlay p.answer {
            font-size: 20px;
            color: black;
        }

        .question.done {
            text-decoration: line-through;
            font-size: 16px;
        }
        
        table {
            width: 100%;
            height: 100%
        }

        .gamearea th {
            text-align: center;
            height: 10%;
            width: 25%;
            background: url('/img/bg.gif');
            color: white;
            font-size: 25px;
        }

        .gamearea td { 
            text-align: center;
            height: 15%;
            width: 25%;
            color: white;
            font-size: 20px;
            background: url('/img/bg.gif');
        }
    </style>
</head>

<body>

<h1> GEOPARTY</h1>

<div hidden id="game">
    <div class="row">
        <div class="col-md-2">
            <h3> Players </h3>
            <ul class="playerlist">
            </ul>
        </div>
        <div class="col-md-9 gamearea">
        </div>
        <div hidden class="col-md-9 overlay">
        </div>
    </div>
</div>

<div id="name">
    Who are you? <input /> <button id="submit">Join the game</button>
</div>
<script>
    var socket = io();
    $(function() {
        $('#submit').on('click', function(ev) {
            var name = $(ev.target).parent().find('input').val();
            $('#name').hide();
            socket.emit('name', {'name': name});
            $('#game').show();
        });

        socket.on('playerChange', function(data) {
            var ul = $('.playerlist');
            ul.empty();
            _.each(data.players, function(p) {
                var $li = $('<li>');
                $li.append(p.name);
                ul.append($li);
            });
        });

        socket.on('gameInit', function(data) {
            var $target = $('.gamearea');
            $target.empty();
            var $table = $('<table>');
            var $headerRow = $('<tr>');
            var row1 = $('<tr>');
            var row2 = $('<tr>');
            var row3 = $('<tr>');
            var row4 = $('<tr>');
            var row5 = $('<tr>');
            var rows = [row1, row2, row3, row4, row5];
            for(var category in data.questions) {
                var $th = $('<th>');
                $th.html(category);
                $headerRow.append($th);
                var questions = data.questions[category];
                _.each(questions, function(q, i) {
                    var row = $(rows[i]);
                    var $td = $('<td>');
                    $td.html(q.value);
                    $td.attr({'class': 'question'});
                    $td.attr({'data-key': q.value + '::' + q.category});
                    row.append($td);
                });
            }
            $table.append($headerRow);
            _.each(rows, function(r) {
                $table.append(r);
            });
            $target.append($table);
        });

        $('.gamearea').on('click', '.question:not(.done)', function(ev) {
            var key = $(ev.target).data('key');
            console.log(typeof(key));
            socket.emit('getQuestion', key); 
        });

        socket.on('showQuestion', function(q) {
            $('.gamearea').hide();
            var over = $('.overlay');
            over.empty();
            var p = $('<p>');
            var p2 = $('<p>');
            var input = $('<input>');
            var button = $('<button>');
            button.html('Answer');
            p.html(q.question);
            p2.append(input);
            p2.append(button);
            p2.attr('data-key', q.value + '::' + q.category);
            p2.attr('class', 'answer');
            over.append(p);
            over.append(p2);
            over.show();
        });

       $('.overlay').on('click', 'button', function(ev) {
            var $target = $(ev.target);
            var key = $target.parent().data('key');
            var answer = $target.parent().find('input').val();
            socket.emit('guess', {question: key, answer: answer});
            $('.overlay').hide();
            $('.question[data-key="' + key + '"]').empty();
            $('.question[data-key="' + key + '"]').addClass('done');
            $('.gamearea').show();
       });
    });
</script>
</body>
</html>
